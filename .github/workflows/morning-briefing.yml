name: Morning Briefing

on:
  # ë§¤ì¼ 07:00 KST (22:00 UTC ì „ë‚ ) ì‹¤í–‰
  schedule:
    - cron: '0 22 * * *'  # UTC 22:00 = KST 07:00 (ë‹¤ìŒë‚ )
  
  # ìˆ˜ë™ ì‹¤í–‰ ì§€ì›
  workflow_dispatch:

# GitHub Pages ë°°í¬ ê¶Œí•œ
permissions:
  contents: write
  pages: write
  id-token: write

# ë™ì‹œ ì‹¤í–‰ ë°©ì§€
concurrency:
  group: "morning-briefing"
  cancel-in-progress: false

jobs:
  briefing:
    name: Generate Morning Briefing
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ì „ì²´ íˆìŠ¤í† ë¦¬ (ì•„ì¹´ì´ë¸Œìš©)

      - name: ğŸ”§ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: |
          echo "ğŸ“‹ Checking package files..."
          ls -la package*.json
          echo ""
          echo "ğŸ”§ Running npm ci..."
          npm ci
          echo "âœ… Dependencies installed successfully"

      - name: ğŸ” Setup Environment Variables
        env:
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          GOOGLE_REFRESH_TOKEN: ${{ secrets.GOOGLE_REFRESH_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          WEATHER_API_KEY: ${{ secrets.WEATHER_API_KEY }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
          EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
          GITHUB_PAGES_URL: ${{ secrets.GITHUB_PAGES_URL }}
        run: |
          echo "Environment variables loaded"
          echo "Total variables: $(env | grep -v "GITHUB\|PATH\|HOME" | wc -l)"

      - name: ğŸŒ… Run Morning Briefing
        env:
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          GOOGLE_REFRESH_TOKEN: ${{ secrets.GOOGLE_REFRESH_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          WEATHER_API_KEY: ${{ secrets.WEATHER_API_KEY }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
          EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
          GITHUB_PAGES_URL: ${{ secrets.GITHUB_PAGES_URL }}
          TZ: Asia/Seoul
          NODE_ENV: production
        run: |
          echo "ğŸš€ Starting Morning Briefing generation..."
          echo "ğŸ“‹ Environment check:"
          echo "  - Node version: $(node --version)"
          echo "  - NPM version: $(npm --version)"
          echo "  - Timezone: $TZ"
          echo "  - Working directory: $(pwd)"
          echo ""
          echo "ğŸ”‘ Checking environment variables (without revealing secrets):"
          echo "  - GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:+SET}"
          echo "  - GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET:+SET}"
          echo "  - GOOGLE_REFRESH_TOKEN: ${GOOGLE_REFRESH_TOKEN:+SET}"
          echo "  - OPENAI_API_KEY: ${OPENAI_API_KEY:+SET}"
          echo "  - WEATHER_API_KEY: ${WEATHER_API_KEY:+SET}"
          echo "  - EMAIL_TO: ${EMAIL_TO:+SET}"
          echo "  - EMAIL_FROM: ${EMAIL_FROM:+SET}"
          echo "  - GITHUB_PAGES_URL: ${GITHUB_PAGES_URL:+SET}"
          echo ""
          echo "â–¶ï¸ Running npm start..."
          npm start 2>&1 | tee briefing.log || {
            EXIT_CODE=$?
            echo ""
            echo "âŒ Morning Briefing generation failed!"
            echo "Exit code: $EXIT_CODE"
            echo ""
            echo "ğŸ“‹ Last 50 lines of output:"
            tail -n 50 briefing.log
            exit 1
          }
          echo "âœ… Morning Briefing generation completed successfully"

      - name: ğŸ“Š Check Output Files
        run: |
          echo "Generated files:"
          ls -lh docs/
          if [ -f docs/today.html ]; then
            echo "âœ… today.html exists ($(stat -f%z docs/today.html 2>/dev/null || stat -c%s docs/today.html) bytes)"
          else
            echo "âŒ today.html not found"
          fi
          if [ -f docs/today.mp3 ]; then
            echo "âœ… today.mp3 exists ($(stat -f%z docs/today.mp3 2>/dev/null || stat -c%s docs/today.mp3) bytes)"
          else
            echo "âš ï¸ today.mp3 not found (audio generation may have failed)"
          fi

      - name: ğŸš€ Deploy to GitHub Pages
        if: success()
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # docs í´ë”ê°€ ìˆëŠ”ì§€ í™•ì¸
          if [ -d "docs" ]; then
            git add docs/
            
            # ë³€ê²½ì‚¬í•­ì´ ìˆëŠ” ê²½ìš°ì—ë§Œ ì»¤ë°‹
            if git diff --staged --quiet; then
              echo "No changes to commit"
            else
              git commit -m "ğŸŒ… Morning Briefing $(date +'%Y-%m-%d %H:%M KST')"
              git push
              echo "âœ… Successfully deployed to GitHub Pages"
            fi
          else
            echo "âŒ docs folder not found"
            exit 1
          fi

      - name: ğŸ“ Upload Artifacts (for debugging)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: briefing-outputs-${{ github.run_number }}
          path: |
            docs/
          retention-days: 7

  # ì‹¤íŒ¨ ì•Œë¦¼ (ì„ íƒ)
  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: briefing
    if: failure()
    steps:
      - name: ğŸ“§ Send Failure Notification
        run: |
          echo "Morning Briefing workflow failed!"
          echo "Run ID: ${{ github.run_id }}"
          echo "Run URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          # ì—¬ê¸°ì— Slack, Discord, Email ë“±ì˜ ì•Œë¦¼ ë¡œì§ ì¶”ê°€ ê°€ëŠ¥
